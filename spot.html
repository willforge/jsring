<!DOCTYPE html>

<pre>
Your spot is : <span id=spot>spot</span>

</pre>

<script>
const webui = 'http://127.0.0.1:5120';
//const webui = '{{site.data.ipfs.webui}}'
const api_url = webui + '/api/v0/'



var promises = [ getIp(), getPeerID() ]

Promise.all(promises)
.then( results => {
   var ip = results[0];
   var peerid = results[1];
   vat tic = getTic();
   console.log('ip: '+ip);
   console.log('peerid: '+peerid);
}
)
.catch(logError)



function getTic() {
 var date = new Date();
 var result = date.getTime() / 1000;
 console.log('getTic: '+result)
 return result
}

function getIp() {
 // let url = 'https://postman-echo.com/ip'
 // let url = 'https://www.cloudflare.com/cdn-cgi/trace'
 // fetch(url).then(validate)
 let url = 'https://iph.heliohost.org/cgi-bin/jsonip.pl'
 url = 'https://api.ipify.org/?format=json'
 url = 'http://127.0.0.1:8088/cgi-bin/jsonip.pl'
 fetch(url,{mode:"cors"}).then(validate)
 .then( resp => { return resp.json() } )
 .then( json => {
   if (typeof(json.ip) != 'undefined') {
     console.log('ip:',json.ip)
     return json.ip
   } else if (typeof(json.query) != 'undefined') {
     return json.query
   } else {
     console.log('json:',json)
     return '0.0.0.0'
   }
  } )
 .catch( logError )
}

function getPeerID() {
  var url = api_url + 'config?&arg=Identity.PeerID&encoding=json'
  console.log(url);
  return fetchjson(url)
     .then( obj => { return Promise.resolve(obj.Value) })
     .catch(logError)
}


function fetchjson(url) {
  return fetch(url, { method: "GET"} ).then(validate).then( resp => resp.json() )
}

function validate(resp) {
  if (resp.status >= 200 && resp.status < 300) {
    return Promise.resolve(resp)
  }
  return Promise.reject(new Error(resp.statusText))
}
function logError(err) { console.log(err); }

</script>
